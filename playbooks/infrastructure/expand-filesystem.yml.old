---
- name: Extend partition and filesystem after disk expansion
  hosts: all
  become: yes
  vars:
    filesystem: "{{ filesystem }}"
  
  tasks:
    - name: Rescan SCSI bus to detect disk changes
      shell: |
        for host in /sys/class/scsi_host/host*/scan; do
          echo "- - -" > $host
        done
        for device in /sys/class/scsi_device/*/device/rescan; do
          echo 1 > $device
        done
      changed_when: true
    
    - name: Wait for disk changes to be detected
      pause:
        seconds: 5
    
    - name: Get disk device for filesystem
      shell: df {{ filesystem }} | tail -1 | awk '{print $1}'
      register: disk_device
      changed_when: false
      failed_when: disk_device.rc != 0
    
    # - name: Display device information
    #   debug:
    #     msg: "Filesystem {{ filesystem }} is on device {{ disk_device.stdout }}"
    
    - name: Check if device is LVM
      shell: |
        case "{{ disk_device.stdout }}" in
          /dev/mapper/*|/dev/dm-*)
            echo "lvm"
            ;;
          *)
            echo "direct"
            ;;
        esac
      args:
        executable: /bin/bash
      register: device_type
      changed_when: false
    
    - name: LVM expansion steps
      block:
        - name: Get physical volume for logical volume
          shell: |
            lvdisplay {{ disk_device.stdout }} 2>/dev/null | grep 'LV Path' | awk '{print $3}'
          register: lv_path
          changed_when: false
        
        - name: Get volume group name
          shell: |
            lvdisplay {{ disk_device.stdout }} 2>/dev/null | grep 'VG Name' | awk '{print $3}'
          register: vg_name
          changed_when: false
        
        - name: Get physical volume
          shell: |
            pvs --noheadings -o pv_name -S vg_name={{ vg_name.stdout }} | tr -d ' ' | head -1
          register: pv_name
          changed_when: false
        
        - name: Validate physical volume was found
          fail:
            msg: "Could not find physical volume for volume group {{ vg_name.stdout }}"
          when: pv_name.stdout == ""
        
        - name: Display LVM structure
          debug:
            msg: 
              - "Logical Volume: {{ lv_path.stdout }}"
              - "Volume Group: {{ vg_name.stdout }}"
              - "Physical Volume: {{ pv_name.stdout }}"
        
        - name: Get partition from physical volume
          shell: echo {{ pv_name.stdout }} | grep -o '[0-9]*$'
          register: partition_num
          changed_when: false
        
        - name: Get disk from physical volume
          shell: echo {{ pv_name.stdout }} | sed 's/[0-9]*$//'
          register: base_disk
          changed_when: false
        
        - name: Validate partition information
          fail:
            msg: "Could not extract partition number from {{ pv_name.stdout }}"
          when: partition_num.stdout == "" or base_disk.stdout == ""
        
        - name: Fix GPT partition table if needed
          shell: echo "Fix" | parted --pretend-input-tty {{ base_disk.stdout }} print
          register: gpt_fix
          changed_when: "'Warning' in gpt_fix.stdout or 'Error' in gpt_fix.stdout"
          failed_when: false
        
        - name: Extend partition with growpart
          shell: growpart {{ base_disk.stdout }} {{ partition_num.stdout }}
          register: growpart_result
          changed_when: "'CHANGED' in growpart_result.stdout"
          failed_when: 
            - growpart_result.rc != 0
            - "'NOCHANGE' not in growpart_result.stdout"
        
        - name: Resize physical volume
          shell: pvresize {{ pv_name.stdout }}
          when: growpart_result.changed
          register: pvresize_result
        
        - name: Check volume group free space
          shell: vgdisplay {{ vg_name.stdout }} | grep 'Free  PE' | awk '{print $5, $6}'
          register: vg_free
          changed_when: false
        
        - name: Extend logical volume to use all free space
          shell: lvextend -l +100%FREE {{ lv_path.stdout }}
          register: lvextend_result
          changed_when: "'successfully resized' in lvextend_result.stdout"
          failed_when:
            - lvextend_result.rc != 0
            - "'matches existing size' not in lvextend_result.stdout"
            - "'New size' not in lvextend_result.stdout"
        
        - name: Display LV extend result
          debug:
            msg: "{{ lvextend_result.stdout_lines }}"
          when: lvextend_result.changed
      
      when: device_type.stdout == "lvm"
    
    - name: Direct partition expansion
      block:
        - name: Get partition number from device
          shell: echo {{ disk_device.stdout }} | grep -o '[0-9]*$'
          register: part_num
          changed_when: false
        
        - name: Get base disk from device
          shell: echo {{ disk_device.stdout }} | sed 's/[0-9]*$//'
          register: base_disk
          changed_when: false
        
        - name: Extend partition with growpart
          shell: growpart {{ base_disk.stdout }} {{ part_num.stdout }}
          register: growpart_result
          changed_when: "'CHANGED' in growpart_result.stdout"
          failed_when: 
            - growpart_result.rc != 0
            - "'NOCHANGE' not in growpart_result.stdout"
      
      when: device_type.stdout == "direct"
    
    - name: Detect filesystem type
      shell: df -T {{ filesystem }} | tail -1 | awk '{print $2}'
      register: fs_type
      changed_when: false
    
    - name: Display filesystem type
      debug:
        msg: "Filesystem type: {{ fs_type.stdout }}"
    
    - name: Extend XFS filesystem
      shell: xfs_growfs {{ filesystem }}
      when: 
        - fs_type.stdout == 'xfs'
        - growpart_result.changed or lvextend_result.changed
      register: xfs_result
    
    - name: Extend EXT4 filesystem  
      shell: resize2fs {{ disk_device.stdout }}
      when: 
        - fs_type.stdout in ['ext4', 'ext3', 'ext2']
        - growpart_result.changed or lvextend_result.changed
      register: ext_result
    
    - name: Verify filesystem expansion
      shell: df -h {{ filesystem }}
      register: final_size
      changed_when: false
    
    # - name: Display final filesystem size
    #   debug:
    #     msg: "{{ final_size.stdout_lines }}"